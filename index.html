import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { Power, Coins, Zap, Hammer, HeartHandshake, Share2, Users, Clipboard, Globe, X, Send, MessageSquare, Gamepad, Maximize2, GitBranch, Aperture, ScrollText, DollarSign } from 'lucide-react';

// Tailwind CSS Ã¨ disponibile per l'uso diretto

// --- Configurazione Iniziale ---
const INITIAL_BALANCE = 100;
const STARTING_CPC = 1;
const SOCIAL_BONUS_AMOUNT = 500;
const REFERRAL_BONUS_AMOUNT = 500;
const AUTO_SAVE_INTERVAL = 1500; // Salva ogni 1.5 secondi

// --- Placeholder Firebase (per ambienti senza variabili globali) ---
const STANDALONE_FIREBASE_CONFIG = {
    apiKey: "YOUR_API_KEY", 
    projectId: "YOUR_PROJECT_ID", 
};

let firebaseApp, auth, db;
let FIREBASE_PLACEHOLDERS_USED = true;
let __app_id = 'default-app-id'; // Default App ID

// Inizializzazione Firebase
try {
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : STANDALONE_FIREBASE_CONFIG;
    __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    if (firebaseConfig.apiKey !== "YOUR_API_KEY" && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
        firebaseApp = initializeApp(firebaseConfig);
        auth = getAuth(firebaseApp);
        db = getFirestore(firebaseApp);
        FIREBASE_PLACEHOLDERS_USED = false;
        // La logica di autenticazione Ã¨ gestita in App useEffect
    } else {
        console.warn("Firebase non Ã¨ configurato. Usando Local Storage per il salvataggio.");
    }
} catch (e) {
    console.error("Errore di inizializzazione Firebase, usando Local Storage:", e);
    FIREBASE_PLACEHOLDERS_USED = true;
}

// --- Dizionario Lingue (L) ---
const languageData = {
    'it-IT': {
        loading: "Caricamento stato di gioco...",
        main_title: "ðŸ‡°ðŸ‡µ KIMâ€™S KINGDOM TYCOON ðŸ‡°ðŸ‡µ",
        subtitle: "Simulazione gestionale per la gloria dello Stato",
        nav_home: "Home (Produzione)",
        nav_investments: "Investimenti (Idle)",
        nav_community: "ComunitÃ  (Social)",
        nav_state: "Stato (Info)",
        production_title: "Produzione Manuale",
        click_text: "Clicca per PL!",
        manual_upgrades_title: "Potenziamenti Manuali Click (CPC)",
        investments_title: "Investimenti Nazionali (Idle)",
        social_title: "ComunitÃ  & Bonus",
        referral_link_title: "Link di Referral Personale",
        referral_link_description: "Condividi per un bonus di 500 PL per te e l'invitato!",
        copy_link: "Copia Link",
        state_summary_title: "Riepilogo Stato",
        save_progress_text: "Progresso salvato in tempo reale.",
        id_state: "ID Cittadino:",
        
        // Investimenti (Idle)
        invest_manifesti: { name: "Manifesti di Propaganda", desc: "Aumenta la Fede e i PL generati per secondo." },
        invest_turni: { name: "Turni di Lavoro Estesi", desc: "Potenzia la produzione industriale e il guadagno idle." },
        invest_accademia: { name: "Accademia Militare", desc: "Crea Eserciti di LealtÃ  per una rendita passiva sostanziale." },
        invest_infrastrutture: { name: "Miglioramento Infrastrutture", desc: "Una rete statale piÃ¹ efficiente per massimizzare il profitto." },
        
        // Upgrade Click (CPC)
        upgrade_decreto: { name: "Decreto Lavoro", desc: "Raddoppia i PL ottenuti da ogni singolo click." },
        upgrade_efficienza: { name: "Campagna di Efficienza", desc: "Moltiplicatore aggiuntivo sul tuo guadagno base per click." },
        upgrade_formazione: { name: "Formazione Accelerata", desc: "Aumenta la precisione manuale e il CPC." },
        upgrade_focus: { name: "Ricerche Focalizzate", desc: "Aumenta notevolmente la resa per ogni click." },
        
        // Social Bonuses
        social_x: { name: 'Segui su X', url: "https://x.com/KJF_Sol" },
        social_telegram: { name: 'Unisciti a Telegram', url: "https://t.me/KJFSol" },
        social_discord: { name: 'Unisciti a Discord', url: "https://discord.gg/placeholder" },
        social_twitch: { name: 'Segui su Twitch', url: "https://twitch.tv/placeholder" },

        // Testi pulsanti e UI
        btn_invest: (cost) => `INVESTI (${formatPL(cost)} PL)`,
        btn_cost: (cost) => `Costo: ${formatPL(cost)} PL`,
        btn_purchased: 'ACQUISTATO',
        btn_claim_bonus: 'OTTIENI BONUS',
        btn_claimed: 'RISCATTATO',
        ui_level: (level) => `Livello: ${level}`,
        ui_yield: (cps) => `Rendimento: +${cps} PL/s`,
        ui_multiplier: (multiplier) => `Moltiplicatore: x${multiplier}`,
        
        // Messaggi
        msg_referral_success: (amount, referrerId) => `Bonus Referral di ${formatPL(amount)} PL ottenuto! Grazie all'invito di ${referrerId}.`,
        msg_insufficient_pl: (name, cost) => `Errore: PL insufficienti per ${name}. Servono ${formatPL(cost)} PL.`,
        msg_purchased: (name, level, cost) => `Acquistato ${name} Liv. ${level}. Costo: ${formatPL(cost)} PL.`,
        msg_multiplier_increased: (name, multiplier) => `Acquistato ${name}. CPC aumentato a x${multiplier}.`,
        msg_already_purchased: (name) => `Errore: ${name} Ã¨ giÃ  stato acquistato.`,
        msg_bonus_claimed: (name, amount) => `Bonus "${name}" riscattato! Hai ricevuto ${formatPL(amount)} PL.`,
        msg_bonus_already_claimed: (name) => `Errore: Bonus "${name}" giÃ  riscattato.`,
        msg_copy_success: 'Link di referral copiato negli appunti!',
        msg_copy_error: 'Errore: Impossibile copiare il link.',
        msg_loaded: "Stato caricato.",
        msg_error: "Errore di salvataggio/caricamento. Usa Local Storage.",
    },
    'en-US': {
        loading: "Loading game state...",
        main_title: "ðŸ‡°ðŸ‡µ KIMâ€™S KINGDOM TYCOON ðŸ‡°ðŸ‡µ",
        subtitle: "Management simulation for the glory of the State",
        nav_home: "Home (Production)",
        nav_investments: "Investments (Idle)",
        nav_community: "Community (Social)",
        nav_state: "State (Info)",
        production_title: "Manual Production",
        click_text: "Click for PL!",
        manual_upgrades_title: "Manual Click Upgrades (CPC)",
        investments_title: "National Investments (Idle)",
        social_title: "Community & Bonuses",
        referral_link_title: "Personal Referral Link",
        referral_link_description: "Share for a 500 PL bonus for you and the invitee!",
        copy_link: "Copy Link",
        state_summary_title: "State Summary",
        save_progress_text: "Progress saved in real-time.",
        id_state: "Citizen ID:",

        // Investments (Idle)
        invest_manifesti: { name: "Propaganda Posters", desc: "Increases Faith and PL generated per second." },
        invest_turni: { name: "Extended Work Shifts", desc: "Boosts industrial production and idle earnings." },
        invest_accademia: { name: "Military Academy", desc: "Creates Armies of Loyalty for substantial passive income." },
        invest_infrastrutture: { name: "Infrastructure Improvement", desc: "A more efficient state network to maximize profit." },

        // Upgrade Click (CPC)
        upgrade_decreto: { name: "Labor Decree", desc: "Doubles the PL obtained from each click." },
        upgrade_efficienza: { name: "Efficiency Campaign", desc: "Additional multiplier on your base click earnings." },
        upgrade_formazione: { name: "Accelerated Training", desc: "Increases manual precision and CPC." },
        upgrade_focus: { name: "Focused Research", desc: "Significantly boosts yield for every click." },

        // Social Bonuses
        social_x: { name: 'Follow on X', url: "https://x.com/KJF_Sol" },
        social_telegram: { name: 'Join Telegram', url: "https://t.me/KJFSol" },
        social_discord: { name: 'Join Discord', url: "https://discord.gg/placeholder" },
        social_twitch: { name: 'Follow on Twitch', url: "https://twitch.tv/placeholder" },

        // Testi pulsanti e UI
        btn_invest: (cost) => `INVEST (${formatPL(cost)} PL)`,
        btn_cost: (cost) => `Cost: ${formatPL(cost)} PL`,
        btn_purchased: 'PURCHASED',
        btn_claim_bonus: 'CLAIM BONUS',
        btn_claimed: 'CLAIMED',
        ui_level: (level) => `Level: ${level}`,
        ui_yield: (cps) => `Yield: +${cps} PL/s`,
        ui_multiplier: (multiplier) => `Multiplier: x${multiplier}`,
        
        // Messaggi
        msg_referral_success: (amount, referrerId) => `Referral Bonus of ${formatPL(amount)} PL obtained! Thanks to the invitation from ${referrerId}.`,
        msg_insufficient_pl: (name, cost) => `Error: Insufficient PL for ${name}. Need ${formatPL(cost)} PL.`,
        msg_purchased: (name, level, cost) => `Purchased ${name} Lv. ${level}. Cost: ${formatPL(cost)} PL.`,
        msg_multiplier_increased: (name, multiplier) => `Purchased ${name}. CPC increased to x${multiplier}.`,
        msg_already_purchased: (name) => `Error: ${name} has already been purchased.`,
        msg_bonus_claimed: (name, amount) => `Bonus "${name}" claimed! You received ${formatPL(amount)} PL.`,
        msg_bonus_already_claimed: (name) => `Error: Bonus "${name}" already claimed.`,
        msg_copy_success: 'Referral link copied to clipboard!',
        msg_copy_error: 'Error: Cannot copy link.',
        msg_loaded: "State loaded.",
        msg_error: "Save/load error. Using Local Storage.",
    },
    'fr-FR': {
        loading: "Chargement de l'Ã©tat du jeu...",
        main_title: "ðŸ‡°ðŸ‡µ KIMâ€™S KINGDOM TYCOON ðŸ‡°ðŸ‡µ",
        subtitle: "Simulation de gestion pour la gloire de l'Ã‰tat",
        nav_home: "Accueil (Production)",
        nav_investments: "Investissements (Passif)",
        nav_community: "CommunautÃ© (Social)",
        nav_state: "Ã‰tat (Info)",
        production_title: "Production Manuelle",
        click_text: "Cliquez pour PL!",
        manual_upgrades_title: "AmÃ©liorations Manuelles Click (CPC)",
        investments_title: "Investissements Nationaux (Passif)",
        social_title: "CommunautÃ© & Bonus",
        referral_link_title: "Lien de Parrainage Personnel",
        referral_link_description: "Partagez pour un bonus de 500 PL pour vous et l'invitÃ©!",
        copy_link: "Copier le Lien",
        state_summary_title: "RÃ©sumÃ© de l'Ã‰tat",
        save_progress_text: "Progression sauvegardÃ©e en temps rÃ©el.",
        id_state: "ID Citoyen:",

        // Investments (Idle)
        invest_manifesti: { name: "Affiches de Propagande", desc: "Augmente la Foi et les PL gÃ©nÃ©rÃ©s par seconde." },
        invest_turni: { name: "Quart de Travail Ã‰tendus", desc: "Boost la production industrielle et les gains passifs." },
        invest_accademia: { name: "AcadÃ©mie Militaire", desc: "CrÃ©e des ArmÃ©es de LoyautÃ© pour un revenu passif substantiel." },
        invest_infrastrutture: { name: "AmÃ©lioration des Infrastructures", desc: "Un rÃ©seau Ã©tatique plus efficace pour maximiser le profit." },

        // Upgrade Click (CPC)
        upgrade_decreto: { name: "DÃ©cret de Travail", desc: "Double les PL obtenus Ã  chaque clic." },
        upgrade_efficienza: { name: "Campagne d'EfficacitÃ©", desc: "Multiplicateur additionnel sur vos gains de clic de base." },
        upgrade_formazione: { name: "Formation AccÃ©lÃ©rÃ©e", desc: "Augmente la prÃ©cision manuelle et le CPC." },
        upgrade_focus: { name: "Recherche FocalisÃ©e", desc: "Augmente considÃ©rablement le rendement Ã  chaque clic." },

        // Social Bonuses
        social_x: { name: 'Suivre sur X', url: "https://x.com/KJF_Sol" },
        social_telegram: { name: 'Rejoindre Telegram', url: "https://t.me/KJFSol" },
        social_discord: { name: 'Rejoindre Discord', url: "https://discord.gg/placeholder" },
        social_twitch: { name: 'Suivre sur Twitch', url: "https://twitch.tv/placeholder" },

        // Testi pulsanti e UI
        btn_invest: (cost) => `INVESTIR (${formatPL(cost)} PL)`,
        btn_cost: (cost) => `CoÃ»t: ${formatPL(cost)} PL`,
        btn_purchased: 'ACHETÃ‰',
        btn_claim_bonus: 'RÃ‰CLAMER BONUS',
        btn_claimed: 'RÃ‰CLAMÃ‰',
        ui_level: (level) => `Niveau: ${level}`,
        ui_yield: (cps) => `Rendement: +${cps} PL/s`,
        ui_multiplier: (multiplier) => `Multiplicateur: x${multiplier}`,

        // Messaggi
        msg_referral_success: (amount, referrerId) => `Bonus de Parrainage de ${formatPL(amount)} PL obtenu! GrÃ¢ce Ã  l'invitation de ${referrerId}.`,
        msg_insufficient_pl: (name, cost) => `Erreur: PL insuffisants pour ${name}. Besoin de ${formatPL(cost)} PL.`,
        msg_purchased: (name, level, cost) => `AchetÃ© ${name} Niv. ${level}. CoÃ»t: ${formatPL(cost)} PL.`,
        msg_multiplier_increased: (name, multiplier) => `AchetÃ© ${name}. CPC augmentÃ© Ã  x${multiplier}.`,
        msg_already_purchased: (name) => `Erreur: ${name} a dÃ©jÃ  Ã©tÃ© achetÃ©.`,
        msg_bonus_claimed: (name, amount) => `Bonus "${name}" rÃ©clamÃ©! Vous avez reÃ§u ${formatPL(amount)} PL.`,
        msg_bonus_already_claimed: (name) => `Erreur: Bonus "${name}" dÃ©jÃ  rÃ©clamÃ©.`,
        msg_copy_success: 'Lien de parrainage copiÃ© dans le presse-papiers!',
        msg_copy_error: 'Erreur: Impossible de copier le lien.',
        msg_loaded: "Ã‰tat chargÃ©.",
        msg_error: "Erreur de sauvegarde/chargement. Utilisation du Local Storage.",
    },
    'zh-CN': {
        loading: "æ­£åœ¨åŠ è½½æ¸¸æˆçŠ¶æ€...",
        main_title: "ðŸ‡°ðŸ‡µ é‡‘æ°çŽ‹å›½å¤§äº¨ ðŸ‡°ðŸ‡µ",
        subtitle: "ä¸ºå›½å®¶è£è€€è€Œè®¾çš„ç®¡ç†æ¨¡æ‹Ÿæ¸¸æˆ",
        nav_home: "é¦–é¡µ (ç”Ÿäº§)",
        nav_investments: "æŠ•èµ„ (æŒ‚æœº)",
        nav_community: "ç¤¾åŒº (ç¤¾äº¤)",
        nav_state: "å›½å®¶ (ä¿¡æ¯)",
        production_title: "æ‰‹åŠ¨ç”Ÿäº§",
        click_text: "ç‚¹å‡»èµšå– PL!",
        manual_upgrades_title: "æ‰‹åŠ¨ç‚¹å‡»å‡çº§ (CPC)",
        investments_title: "å›½å®¶æŠ•èµ„ (æŒ‚æœº)",
        social_title: "ç¤¾åŒºä¸Žå¥–åŠ±",
        referral_link_title: "ä¸ªäººæŽ¨èé“¾æŽ¥",
        referral_link_description: "åˆ†äº«å¯ä¸ºæ‚¨å’Œå—é‚€è€…èµ¢å¾— 500 PL å¥–åŠ±ï¼",
        copy_link: "å¤åˆ¶é“¾æŽ¥",
        state_summary_title: "å›½å®¶æ‘˜è¦",
        save_progress_text: "è¿›åº¦å·²å®žæ—¶ä¿å­˜ã€‚",
        id_state: "å…¬æ°‘ ID:",

        // Investments (Idle)
        invest_manifesti: { name: "å®£ä¼ æµ·æŠ¥", desc: "æé«˜ä¿¡ä»°å’Œæ¯ç§’äº§ç”Ÿçš„ PLã€‚" },
        invest_turni: { name: "å»¶é•¿å·¥ä½œç­æ¬¡", desc: "æå‡å·¥ä¸šç”Ÿäº§å’ŒæŒ‚æœºæ”¶å…¥ã€‚" },
        invest_accademia: { name: "å†›äº‹å­¦é™¢", desc: "åˆ›å»ºå¿ è¯šå†›é˜Ÿä»¥èŽ·å¾—å¯è§‚çš„è¢«åŠ¨æ”¶å…¥ã€‚" },
        invest_infrastrutture: { name: "åŸºç¡€è®¾æ–½æ”¹å–„", desc: "æ›´é«˜æ•ˆçš„å›½å®¶ç½‘ç»œä»¥å®žçŽ°åˆ©æ¶¦æœ€å¤§åŒ–ã€‚" },

        // Upgrade Click (CPC)
        upgrade_decreto: { name: "åŠ³åŠ¨æ³•ä»¤", desc: "å°†æ¯æ¬¡ç‚¹å‡»èŽ·å¾—çš„ PL ç¿»å€ã€‚" },
        upgrade_efficienza: { name: "æ•ˆçŽ‡è¿åŠ¨", desc: "åŸºç¡€ç‚¹å‡»æ”¶å…¥çš„é¢å¤–ä¹˜æ•°ã€‚" },
        upgrade_formazione: { name: "åŠ é€ŸåŸ¹è®­", desc: "æé«˜æ‰‹åŠ¨ç²¾åº¦å’Œ CPCã€‚" },
        upgrade_focus: { name: "é‡ç‚¹ç ”ç©¶", desc: "æ˜¾ç€æé«˜æ¯æ¬¡ç‚¹å‡»çš„æ”¶ç›Šã€‚" },

        // Social Bonuses
        social_x: { name: 'å…³æ³¨ X', url: "https://x.com/KJF_Sol" },
        social_telegram: { name: 'åŠ å…¥ Telegram', url: "https://t.me/KJFSol" },
        social_discord: { name: 'åŠ å…¥ Discord', url: "https://discord.gg/placeholder" },
        social_twitch: { name: 'å…³æ³¨ Twitch', url: "https://twitch.tv/placeholder" },

        // Testi pulsanti e UI
        btn_invest: (cost) => `æŠ•èµ„ (${formatPL(cost)} PL)`,
        btn_cost: (cost) => `æˆæœ¬: ${formatPL(cost)} PL`,
        btn_purchased: 'å·²è´­ä¹°',
        btn_claim_bonus: 'é¢†å–å¥–åŠ±',
        btn_claimed: 'å·²é¢†å–',
        ui_level: (level) => `ç­‰çº§: ${level}`,
        ui_yield: (cps) => `æ”¶ç›Š: +${cps} PL/s`,
        ui_multiplier: (multiplier) => `ä¹˜æ•°: x${multiplier}`,
        
        // Messaggi
        msg_referral_success: (amount, referrerId) => `èŽ·å¾—äº† ${formatPL(amount)} PL çš„æŽ¨èå¥–åŠ±ï¼æ„Ÿè°¢ ${referrerId} çš„é‚€è¯·ã€‚`,
        msg_insufficient_pl: (name, cost) => `é”™è¯¯ï¼š${name} çš„ PL ä¸è¶³ã€‚éœ€è¦ ${formatPL(cost)} PLã€‚`,
        msg_purchased: (name, level, cost) => `è´­ä¹°äº† ${name} ç­‰çº§ ${level}ã€‚æˆæœ¬: ${formatPL(cost)} PLã€‚`,
        msg_multiplier_increased: (name, multiplier) => `è´­ä¹°äº† ${name}ã€‚CPC å¢žåŠ åˆ° x${multiplier}ã€‚`,
        msg_already_purchased: (name) => `é”™è¯¯ï¼š${name} å·²è´­ä¹°ã€‚`,
        msg_bonus_claimed: (name, amount) => `å·²é¢†å– "${name}" å¥–åŠ±ï¼æ‚¨èŽ·å¾—äº† ${formatPL(amount)} PLã€‚`,
        msg_bonus_already_claimed: (name) => `é”™è¯¯ï¼š"${name}" å¥–åŠ±å·²é¢†å–ã€‚`,
        msg_copy_success: 'æŽ¨èé“¾æŽ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!',
        msg_copy_error: 'é”™è¯¯ï¼šæ— æ³•å¤åˆ¶é“¾æŽ¥ã€‚',
        msg_loaded: "çŠ¶æ€å·²åŠ è½½ã€‚",
        msg_error: "ä¿å­˜/åŠ è½½é”™è¯¯ã€‚ä½¿ç”¨æœ¬åœ°å­˜å‚¨ã€‚",
    },
};

// --- Strutture Dati del Gioco ---

const investmentsData = [
    { id: 1, key: 'invest_manifesti', baseCost: 10, baseCps: 0.1, icon: "ðŸ“¢" },
    { id: 2, key: 'invest_turni', baseCost: 100, baseCps: 1, icon: "ðŸ­" },
    { id: 3, key: 'invest_accademia', baseCost: 1000, baseCps: 5, icon: "ðŸŽ–ï¸" },
    { id: 4, key: 'invest_infrastrutture', baseCost: 15000, baseCps: 50, icon: "ðŸ—ï¸" },
];

const clickUpgradesData = [
    { id: 101, key: 'upgrade_decreto', baseCost: 50, multiplier: 2, icon: ScrollText, stateKey: 'click_upgrade_101' },
    { id: 102, key: 'upgrade_efficienza', baseCost: 500, multiplier: 3, icon: DollarSign, stateKey: 'click_upgrade_102' },
    { id: 103, key: 'upgrade_formazione', baseCost: 5000, multiplier: 5, icon: Aperture, stateKey: 'click_upgrade_103' },
    { id: 104, key: 'upgrade_focus', baseCost: 50000, multiplier: 10, icon: Maximize2, stateKey: 'click_upgrade_104' },
];

const socialBonusesData = [
    { key: 'x_followed', nameKey: 'social_x', icon: X },
    { key: 'telegram_joined', nameKey: 'social_telegram', icon: Send },
    { key: 'discord_joined', nameKey: 'social_discord', icon: MessageSquare },
    { key: 'twitch_followed', nameKey: 'social_twitch', icon: Gamepad },
];

// --- Formattazione e Hook di Lingua ---

const formatPL = (amount, lang = 'it-IT') => Math.floor(amount).toLocaleString(lang);

const useLanguage = () => {
    const [lang, setLang] = useState(localStorage.getItem('gameLanguage') || 'it-IT');
    const L = languageData[lang] || languageData['it-IT'];

    const setAppLanguage = useCallback((newLang) => {
        if (languageData[newLang]) {
            setLang(newLang);
            localStorage.setItem('gameLanguage', newLang);
        }
    }, []);

    return { lang, L, setAppLanguage };
};

// --- Hook di Stato e Logica di Gioco ---

const useGameState = (isAuthReady, initialUserId) => {
    const { lang, L } = useLanguage();
    const [state, setState] = useState(null);
    const [userId, setUserId] = useState(initialUserId);
    const [useLocalStorage, setUseLocalStorage] = useState(true);
    const [message, setMessage] = useState(null);

    const showMessage = useCallback((msg, isError = false) => {
        setMessage({ text: msg, error: isError });
        setTimeout(() => setMessage(null), 5000);
    }, []);

    // Calcola il guadagno passivo (CPS)
    const calculateCps = useMemo(() => {
        if (!state) return 0;
        let totalCps = 0;
        investmentsData.forEach(invest => {
            const level = state.investmentLevels[invest.id] || 0;
            totalCps += invest.baseCps * level;
        });
        return totalCps;
    }, [state]);
    
    // Funzione per aggiornare lo stato e salvare
    const updateState = useCallback((newState) => {
        setState(prev => {
            const finalState = typeof newState === 'function' ? newState(prev) : newState;
            if (finalState) {
                saveState(finalState);
                return finalState;
            }
            return prev;
        });
    }, []);

    // Salva lo stato
    const saveState = useCallback(async (currentState) => {
        if (!currentState) return;
        
        const stateToSave = {
            plBalance: currentState.plBalance,
            investmentLevels: currentState.investmentLevels,
            clickMultiplier: currentState.clickMultiplier,
            clickUpgradePurchased: currentState.clickUpgradePurchased,
            socialBonuses: currentState.socialBonuses,
            referralBonusClaimed: currentState.referralBonusClaimed,
        };

        if (useLocalStorage) {
            localStorage.setItem('gameState', JSON.stringify(stateToSave));
        } else if (db && userId) {
            try {
                const userDocRef = doc(db, "artifacts", __app_id, "users", userId, "game_state", "data");
                await setDoc(userDocRef, stateToSave, { merge: true });
            } catch (e) {
                console.error("Errore nel salvataggio su Firebase:", e);
                // Non mostrare messaggi di errore persistenti, solo in console
            }
        }
    }, [userId, useLocalStorage]);

    // Logica di caricamento dello stato
    const loadState = useCallback((uid, forceLocalStorage) => {
        setUserId(uid);
        setUseLocalStorage(forceLocalStorage);
        
        const defaultState = {
            plBalance: INITIAL_BALANCE,
            investmentLevels: {},
            clickMultiplier: STARTING_CPC,
            clickUpgradePurchased: {},
            socialBonuses: {},
            referralBonusClaimed: false, 
        };

        const applyReferralBonus = (currentState) => {
            const urlParams = new URLSearchParams(window.location.search);
            const referrerId = urlParams.get('ref');

            if (referrerId && referrerId !== uid && !currentState.referralBonusClaimed) {
                
                currentState.plBalance += REFERRAL_BONUS_AMOUNT;
                currentState.referralBonusClaimed = true;
                showMessage(L.msg_referral_success(REFERRAL_BONUS_AMOUNT, referrerId));

                // Aggiungi un piccolo log per il referrer
                // (Qui si farebbe una transazione sul db per premiare il referrer, ma lo saltiamo per semplicitÃ )
            }
            return currentState;
        };

        if (forceLocalStorage) {
            const savedStateString = localStorage.getItem('gameState');
            let loadedState = defaultState;
            if (savedStateString) {
                try {
                    loadedState = { ...defaultState, ...JSON.parse(savedStateString) };
                } catch (e) {
                    console.error("Errore nel parsing LS:", e);
                }
            }
            setState(applyReferralBonus(loadedState));
            showMessage(L.msg_loaded);
            return;
        }

        // Caricamento Firebase
        if (db && uid) {
            const userDocRef = doc(db, "artifacts", __app_id, "users", uid, "game_state", "data");
            
            const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                let loadedState;
                if (docSnap.exists()) {
                    loadedState = { ...defaultState, ...docSnap.data() };
                } else {
                    loadedState = defaultState;
                    // Salva stato iniziale su Firebase se non esiste
                    setDoc(userDocRef, defaultState).catch(err => console.error("Firebase save init error:", err));
                }
                
                setState(applyReferralBonus(loadedState));
                showMessage(L.msg_loaded);

            }, (error) => {
                console.error("Errore di onSnapshot. Fallback a Local Storage:", error);
                setUseLocalStorage(true);
                loadState(uid, true); // Fallback immediato
            });
            return unsubscribe; // Restituisce la funzione di pulizia
        }

    }, [L, showMessage]);

    // Inizializzazione e Autenticazione (Effetto Principale)
    useEffect(() => {
        if (!isAuthReady) return; // Aspetta che onAuthStateChanged sia pronto
        
        let cleanup = () => {};

        if (!FIREBASE_PLACEHOLDERS_USED && auth) {
            // ModalitÃ  Firebase
            const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                let uid;
                if (user) {
                    uid = user.uid;
                } else {
                    // Firma anonima se non giÃ  autenticato
                    try {
                        const credential = await signInAnonymously(auth);
                        uid = credential.user.uid;
                    } catch (e) {
                        console.error("Errore anonimo Firebase, usando fallback locale:", e);
                        const localId = localStorage.getItem('userId') || crypto.randomUUID();
                        localStorage.setItem('userId', localId);
                        setUserId(localId);
                        setUseLocalStorage(true);
                        loadState(localId, true);
                        return;
                    }
                }
                const unsubscribeSnapshot = loadState(uid, false);
                cleanup = unsubscribeSnapshot;
            });
            return () => {
                unsubscribeAuth();
                cleanup();
            };
        } else {
            // ModalitÃ  Local Storage (Fallback)
            const localId = localStorage.getItem('userId') || crypto.randomUUID();
            localStorage.setItem('userId', localId);
            setUserId(localId);
            setUseLocalStorage(true);
            loadState(localId, true);
        }

    }, [isAuthReady, loadState]);

    // Game Loop (Aggiornamento CPS)
    useEffect(() => {
        if (!state) return;
        
        const interval = setInterval(() => {
            setState(prev => {
                if (!prev) return prev;
                const cps = calculateCps;
                if (cps === 0) return prev;
                return { ...prev, plBalance: prev.plBalance + cps / 10 };
            });
        }, 100); 

        return () => clearInterval(interval);
    }, [state, calculateCps]);

    // Auto-Save Interval (per Local Storage o per forzare il merge su Firebase)
    useEffect(() => {
        if (!state) return;

        const interval = setInterval(() => {
             saveState(state);
        }, AUTO_SAVE_INTERVAL);

        return () => clearInterval(interval);
    }, [state, saveState]);


    // --- Funzioni di Interazione (Handlers) ---

    const handleManualClick = () => {
        if (!state) return;
        updateState(prev => ({
            ...prev,
            plBalance: prev.plBalance + prev.clickMultiplier,
        }));
    };

    const handleBuyInvestment = (invest) => {
        if (!state) return;
        updateState(prev => {
            const currentLevel = prev.investmentLevels[invest.id] || 0;
            const cost = Math.floor(invest.baseCost * Math.pow(1.15, currentLevel));
            const investName = L[invest.key].name;
            
            if (prev.plBalance >= cost) {
                const newLevels = { ...prev.investmentLevels, [invest.id]: currentLevel + 1 };
                showMessage(L.msg_purchased(investName, currentLevel + 1, cost));
                return {
                    ...prev,
                    plBalance: prev.plBalance - cost,
                    investmentLevels: newLevels,
                };
            } else {
                showMessage(L.msg_insufficient_pl(investName, cost), true);
                return prev;
            }
        });
    };

    const handleBuyClickUpgrade = (upgrade) => {
        if (!state) return;
        updateState(prev => {
            const cost = upgrade.baseCost;
            const isPurchased = prev.clickUpgradePurchased[upgrade.stateKey];
            const upgradeName = L[upgrade.key].name;

            if (isPurchased) {
                showMessage(L.msg_already_purchased(upgradeName), true);
                return prev;
            }
            
            if (prev.plBalance >= cost) {
                const newUpgrades = { ...prev.clickUpgradePurchased, [upgrade.stateKey]: true };
                const newMultiplier = prev.clickMultiplier * upgrade.multiplier;
                showMessage(L.msg_multiplier_increased(upgradeName, newMultiplier));

                return {
                    ...prev,
                    plBalance: prev.plBalance - cost,
                    clickMultiplier: newMultiplier,
                    clickUpgradePurchased: newUpgrades,
                };
            } else {
                showMessage(L.msg_insufficient_pl(upgradeName, cost), true);
                return prev;
            }
        });
    };

    const handleClaimSocialBonus = (bonus) => {
        if (!state) return;
        const bonusName = L[bonus.nameKey].name;

        if (state.socialBonuses[bonus.key]) {
            showMessage(L.msg_bonus_already_claimed(bonusName), true);
            return;
        }

        // Apri il link prima di applicare il bonus
        window.open(L[bonus.nameKey].url, '_blank');

        updateState(prev => {
            const newBonuses = { ...prev.socialBonuses, [bonus.key]: true };
            showMessage(L.msg_bonus_claimed(bonusName, SOCIAL_BONUS_AMOUNT));
            return {
                ...prev,
                plBalance: prev.plBalance + SOCIAL_BONUS_AMOUNT,
                socialBonuses: newBonuses,
            };
        });
    };

    const handleCopyReferral = () => {
        if (!userId) {
             showMessage("Errore: ID utente non disponibile.", true);
             return;
        }

        const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userId}`;
        
        const el = document.createElement('textarea');
        el.value = referralLink;
        document.body.appendChild(el);
        el.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showMessage(L.msg_copy_success);
            } else {
                showMessage(L.msg_copy_error, true);
            }
        } catch (err) {
            showMessage(L.msg_copy_error, true);
        } finally {
            document.body.removeChild(el);
        }
    };


    return {
        state,
        userId,
        useLocalStorage,
        calculateCps,
        message,
        handleManualClick,
        handleBuyInvestment,
        handleBuyClickUpgrade,
        handleClaimSocialBonus,
        handleCopyReferral,
        showMessage
    };
};


// --- Componenti UI ---

// Scheda per i Potenziamenti Click
const ClickUpgradeCard = React.memo(({ upgrade, state, handleBuy, L }) => {
    const cost = upgrade.baseCost;
    const isPurchased = state.clickUpgradePurchased[upgrade.stateKey];
    const canAfford = state.plBalance >= cost && !isPurchased;
    const upgradeStrings = L[upgrade.key];
    const Icon = upgrade.icon;
    
    let buttonText;
    let buttonClass;

    if (isPurchased) {
        buttonText = L.btn_purchased;
        buttonClass = 'bg-green-700 text-white cursor-not-allowed';
    } else if (canAfford) {
        buttonText = L.btn_invest(cost);
        buttonClass = 'bg-yellow-700 hover:bg-yellow-600 text-white';
    } else {
        buttonText = L.btn_cost(cost);
        buttonClass = 'bg-gray-600 text-gray-400 cursor-not-allowed';
    }

    return (
        <div className={`p-4 rounded-lg shadow-xl transition-all border ${canAfford ? 'border-yellow-600/50 bg-gray-800 hover:bg-gray-700' : 'border-gray-600/50 bg-gray-900 opacity-70'}`}>
            <div className="flex items-center space-x-3 mb-2">
                <Icon className="w-6 h-6 text-yellow-400" />
                <h3 className="text-xl font-bold text-white">{upgradeStrings.name}</h3>
            </div>
            <p className="text-sm text-gray-400 mb-3">{upgradeStrings.desc}</p>
            <div className="flex justify-between items-center text-sm mb-3">
                <span className="text-yellow-400 font-medium">{L.ui_multiplier(upgrade.multiplier)}</span>
            </div>
            <button 
                onClick={() => handleBuy(upgrade)}
                className={`w-full py-2 rounded-lg font-semibold transition-all shadow-md active:scale-95 ${buttonClass}`} 
                disabled={!canAfford || isPurchased}
            >
                {buttonText}
            </button>
        </div>
    );
});

// Scheda per gli Investimenti Idle
const InvestmentCard = React.memo(({ invest, state, handleBuy, L }) => {
    const currentLevel = state.investmentLevels[invest.id] || 0;
    const cost = Math.floor(invest.baseCost * Math.pow(1.15, currentLevel));
    const currentCps = (invest.baseCps * currentLevel).toFixed(1);
    const canAfford = state.plBalance >= cost;
    const investStrings = L[invest.key];
    
    return (
        <div className={`p-4 rounded-lg shadow-xl transition-all border ${canAfford ? 'border-green-600/50 bg-gray-800 hover:bg-gray-700' : 'border-red-600/50 bg-gray-900 opacity-70'}`}>
            <div className="flex items-center space-x-3 mb-2">
                <span className="text-3xl">{invest.icon}</span>
                <h3 className="text-xl font-bold text-white">{investStrings.name}</h3>
            </div>
            <p className="text-sm text-gray-400 mb-3">{investStrings.desc}</p>
            
            <div className="flex justify-between items-center text-sm mb-3">
                <span className="text-yellow-400 font-medium">{L.ui_level(currentLevel)}</span>
                <span className="text-green-400 font-medium">{L.ui_yield(currentCps)}</span>
            </div>
            <button 
                onClick={() => handleBuy(invest)}
                className={`buy-invest-btn w-full py-2 rounded-lg font-semibold transition-all shadow-md active:scale-95 ${
                    canAfford ? 'bg-red-700 hover:bg-red-600 text-white' : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                }`} 
                disabled={!canAfford}>
                {canAfford ? L.btn_invest(cost) : L.btn_cost(cost)}
            </button>
        </div>
    );
});

// Scheda per i Bonus Social
const SocialBonusCard = React.memo(({ bonus, state, handleClaim, L }) => {
    const isClaimed = state.socialBonuses[bonus.key];
    const bonusName = L[bonus.nameKey].name;
    const Icon = bonus.icon;

    let buttonText = isClaimed ? L.btn_claimed : L.btn_claim_bonus;
    let buttonClass = isClaimed ? 'bg-green-700 text-white cursor-not-allowed' : 'bg-sky-700 hover:bg-sky-600 text-white active:scale-95';

    return (
        <div className={`p-4 rounded-lg shadow-md border ${isClaimed ? 'border-green-600/50 bg-green-900/20' : 'border-sky-600/50 bg-gray-900/50'}`}>
            <div className="flex justify-between items-center">
                <div>
                    <h4 className="text-lg font-semibold text-white flex items-center">
                        <Icon className="w-4 h-4 mr-1 text-sky-400" />
                        {bonusName}
                    </h4>
                    <p className="text-sm text-yellow-300">+ {formatPL(SOCIAL_BONUS_AMOUNT, L.lang)} PL</p>
                </div>
                <button 
                    onClick={() => handleClaim(bonus)}
                    className={`claim-bonus-btn py-2 px-4 rounded-full font-semibold transition-all shadow-lg ${buttonClass}`} 
                    disabled={isClaimed}
                >
                    {buttonText}
                </button>
            </div>
        </div>
    );
});


// --- Pagine del Gioco ---

const HomePage = ({ state, handleManualClick, handleBuyClickUpgrade, L }) => (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Colonna Clicker */}
        <div className="lg:col-span-1 flex flex-col items-center">
            <h2 className="text-3xl font-bold text-red-400 mb-4 flex items-center">
                <Hammer className="w-6 h-6 mr-2" />
                {L.production_title}
            </h2>
            <button
                onClick={handleManualClick}
                className="click-button w-full h-64 sm:h-80 transition-all rounded-2xl shadow-2xl flex flex-col items-center justify-center text-white p-4 
                    bg-gradient-to-br from-red-600 to-red-900 border-b-8 border-red-900 hover:from-red-500 hover:to-red-800 active:scale-98 active:border-b-4"
            >
                <Power className="w-16 h-16 mb-2 text-yellow-300" />
                <span className="text-3xl font-extrabold">{L.click_text}</span>
                <span className="text-xl mt-2 font-semibold text-yellow-300">
                    +{formatPL(state.clickMultiplier, L.lang)} PL
                </span>
            </button>
            
            {/* Upgrade Click */}
            <div className="w-full mt-6 space-y-4">
                <h3 className="text-xl font-bold text-yellow-400 mt-4 border-b border-gray-700 pb-2">{L.manual_upgrades_title}</h3>
                <div className="space-y-4">
                    {clickUpgradesData.map(upgrade => (
                        <ClickUpgradeCard 
                            key={upgrade.id} 
                            upgrade={upgrade} 
                            state={state} 
                            handleBuy={handleBuyClickUpgrade} 
                            L={L} 
                        />
                    ))}
                </div>
            </div>
        </div>

        {/* Placeholder per schermi grandi */}
        <div className="hidden lg:block lg:col-span-2">
            <div className="h-full flex items-center justify-center text-gray-600 text-2xl font-bold border-2 border-dashed border-gray-700 rounded-xl p-8">
                {L.nav_investments} & {L.nav_community} sono nelle altre sezioni di navigazione.
            </div>
        </div>
    </div>
);

const InvestmentsPage = ({ state, handleBuyInvestment, L }) => (
    <>
        <h2 className="text-3xl font-bold text-sky-400 mb-6 flex items-center border-b border-gray-700 pb-2">
            <HeartHandshake className="w-6 h-6 mr-2" />
            {L.investments_title}
        </h2>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {investmentsData.map(invest => (
                <InvestmentCard 
                    key={invest.id} 
                    invest={invest} 
                    state={state} 
                    handleBuy={handleBuyInvestment} 
                    L={L} 
                />
            ))}
        </div>
    </>
);

const CommunityPage = ({ state, handleClaimSocialBonus, handleCopyReferral, userId, L }) => {
    const referralLink = `${window.location.origin}${window.location.pathname}?ref=${userId}`;

    return (
        <div className="p-6 bg-gray-800/70 border border-indigo-700 rounded-xl shadow-2xl">
            <h3 className="text-2xl font-bold text-indigo-400 mb-4 flex items-center border-b border-gray-700 pb-2">
                <Share2 className="w-5 h-5 mr-2" />
                {L.social_title}
            </h3>
            
            {/* Sezione Link Referral */}
            <div className="mb-8 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 className="text-xl font-semibold text-white mb-2">{L.referral_link_title}</h4>
                <p className="text-gray-400 text-sm mb-3">{L.referral_link_description}</p>
                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 items-center">
                    <p className="p-2 bg-gray-700 rounded text-sm text-yellow-300 font-mono overflow-auto w-full sm:w-auto">
                        {referralLink.length > 50 ? `${referralLink.substring(0, 50)}...` : referralLink}
                    </p>
                    <button
                        onClick={handleCopyReferral}
                        className="flex items-center py-2 px-4 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-lg transition-colors active:scale-95 shadow-md w-full sm:w-auto justify-center"
                    >
                        <Clipboard className="w-4 h-4 mr-2" />
                        {L.copy_link}
                    </button>
                </div>
            </div>

            {/* Messaggio Bonus Referral (mostrato se reclamato) */}
            {state.referralBonusClaimed && (
                 <div className="p-4 mb-4 bg-green-900/50 border border-green-600 rounded-lg text-white font-semibold">
                    {L.msg_referral_success(REFERRAL_BONUS_AMOUNT, new URLSearchParams(window.location.search).get('ref') || 'Stato')}
                 </div>
            )}

            {/* Bonus Social */}
            <h4 className="text-xl font-semibold text-white mb-3">Bonus Disponibili:</h4>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {socialBonusesData.map(bonus => (
                    <SocialBonusCard 
                        key={bonus.key} 
                        bonus={bonus} 
                        state={state} 
                        handleClaim={handleClaimSocialBonus} 
                        L={L} 
                    />
                ))}
            </div>
        </div>
    );
};

const StatePage = ({ userId, useLocalStorage, lang, setAppLanguage, L }) => {
    
    // Lista delle lingue disponibili per il selettore
    const languageOptions = [
        { value: 'it-IT', label: 'ðŸ‡®ðŸ‡¹ Italiano' },
        { value: 'en-US', label: 'ðŸ‡¬ðŸ‡§ English' },
        { value: 'zh-CN', label: 'ðŸ‡¨ðŸ‡³ ä¸­æ–‡ (Chinese)' },
        { value: 'fr-FR', label: 'ðŸ‡«ðŸ‡· FranÃ§ais' },
    ];

    return (
        <div className="p-6 bg-gray-800/70 border border-gray-700 rounded-xl shadow-2xl space-y-6">
            <h3 className="text-2xl font-bold text-red-400 mb-4 flex items-center border-b border-gray-700 pb-2">
                <GitBranch className="w-5 h-5 mr-2" />
                {L.state_summary_title}
            </h3>

            {/* Dettagli Stato */}
            <div className="space-y-4">
                <div className="flex items-center space-x-3 bg-gray-900 p-3 rounded-lg">
                    <Users className="w-5 h-5 text-red-500" />
                    <p className="text-gray-400 font-medium">{L.id_state}</p>
                    <p className="text-sm font-mono text-white break-all">{userId || 'N/A'}</p>
                </div>
                <div className="flex items-center space-x-3 bg-gray-900 p-3 rounded-lg">
                    <ScrollText className="w-5 h-5 text-yellow-500" />
                    <p className="text-gray-400 font-medium">ModalitÃ  Salvataggio:</p>
                    <p className={`text-sm font-semibold ${useLocalStorage ? 'text-yellow-400' : 'text-green-400'}`}>
                        {useLocalStorage ? 'Locale (Local Storage)' : 'Cloud (Firebase)'}
                    </p>
                </div>
            </div>

            {/* Selettore Lingua */}
            <div className="pt-4 border-t border-gray-700">
                <h4 className="text-xl font-bold text-white mb-3 flex items-center">
                    <Globe className="w-5 h-5 mr-2" />
                    Selezione Lingua
                </h4>
                <select 
                    value={lang} 
                    onChange={(e) => setAppLanguage(e.target.value)}
                    className="p-2 rounded-lg bg-gray-700 text-white border border-gray-600 shadow-md focus:ring-red-500 focus:border-red-500 w-full"
                >
                    {languageOptions.map(option => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                    ))}
                </select>
            </div>
            
            <p className="text-gray-500 text-xs pt-4 border-t border-gray-700">{L.save_progress_text}</p>
        </div>
    );
};


// --- Componente Principale App ---
const App = () => {
    const [isAuthReady, setIsAuthReady] = useState(false);
    const { lang, L, setAppLanguage } = useLanguage();
    const [page, setPage] = useState('home'); // Stato per la navigazione
    
    // Simula l'attesa di `onAuthStateChanged` prima di inizializzare il gioco
    useEffect(() => {
        // Se non usiamo Firebase o la token non Ã¨ presente, l'auth Ã¨ "pronta" subito
        if (FIREBASE_PLACEHOLDERS_USED || typeof __initial_auth_token === 'undefined') {
            setIsAuthReady(true);
            return;
        }

        // Se usiamo Firebase e c'Ã¨ il token, prova il login con token
        const tryTokenLogin = async () => {
            if (auth && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await auth.signInWithCustomToken(__initial_auth_token);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.warn("Custom token failed. Will rely on anonymous sign-in in useGameState.", error);
                }
            }
            setIsAuthReady(true); // L'auth Ã¨ pronta per essere gestita da useGameState
        };
        tryTokenLogin();
        
    }, []);

    const { 
        state, 
        userId, 
        useLocalStorage,
        calculateCps, 
        message, 
        handleManualClick, 
        handleBuyInvestment, 
        handleBuyClickUpgrade,
        handleClaimSocialBonus,
        handleCopyReferral,
    } = useGameState(isAuthReady, localStorage.getItem('userId') || null);

    // Mappa le pagine con i componenti
    const renderPage = () => {
        if (!state) return null;

        switch (page) {
            case 'home':
                return <HomePage 
                    state={state} 
                    handleManualClick={handleManualClick} 
                    handleBuyClickUpgrade={handleBuyClickUpgrade} 
                    L={L} 
                />;
            case 'investments':
                return <InvestmentsPage 
                    state={state} 
                    handleBuyInvestment={handleBuyInvestment} 
                    L={L} 
                />;
            case 'community':
                return <CommunityPage 
                    state={state} 
                    handleClaimSocialBonus={handleClaimSocialBonus} 
                    handleCopyReferral={handleCopyReferral}
                    userId={userId}
                    L={L} 
                />;
            case 'state':
                return <StatePage 
                    userId={userId} 
                    useLocalStorage={useLocalStorage} 
                    lang={lang}
                    setAppLanguage={setAppLanguage}
                    L={L}
                />;
            default:
                return <HomePage state={state} handleManualClick={handleManualClick} L={L} />;
        }
    };
    
    const navItems = useMemo(() => [
        { id: 'home', label: L.nav_home, icon: Hammer },
        { id: 'investments', label: L.nav_investments, icon: DollarSign },
        { id: 'community', label: L.nav_community, icon: Users },
        { id: 'state', label: L.nav_state, icon: GitBranch },
    ], [L]);

    if (!state) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-900">
                <div className="text-center text-white">
                    <svg className="w-10 h-10 animate-spin text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p className="text-xl mt-2">{L.loading}</p>
                </div>
            </div>
        );
    }
    
    const totalCps = calculateCps;

    return (
        <div className="min-h-screen bg-gray-900 text-white p-4 sm:p-8">
            <div className="max-w-6xl mx-auto">

                <header className="text-center mb-6">
                    <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-400 mb-1">
                        {L.main_title}
                    </h1>
                    <p className="text-gray-400 text-lg">{L.subtitle}</p>
                </header>
                
                {/* Header Saldo e CPS */}
                <div className="flex flex-wrap justify-center sm:justify-between items-center p-3 sm:p-4 mb-6 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl">
                    <div className="flex items-center p-2 bg-yellow-900/40 border border-yellow-500/50 rounded-full mb-2 sm:mb-0">
                        <Coins className="w-6 h-6 text-yellow-400 mr-2" />
                        <p className="text-xl sm:text-2xl font-bold text-white">
                            PL: <span className="text-yellow-300">{formatPL(state.plBalance, L.lang)}</span>
                        </p>
                    </div>
                    <div className="flex items-center p-2 bg-green-900/40 border border-green-500/50 rounded-full">
                        <Zap className="w-6 h-6 text-green-400 mr-1" />
                        <p className="text-md sm:text-lg font-semibold text-white">
                            <span className="text-green-300">+{totalCps.toFixed(1)}</span> /s
                        </p>
                    </div>
                </div>

                {/* Messaggio di Stato */}
                {message && (
                    <div className={`text-center p-3 mb-6 rounded-lg font-medium shadow-md ${
                        message.error ? 'bg-red-500/20 text-red-300 border border-red-500' : 'bg-sky-500/20 text-sky-300 border border-sky-500'
                    }`}>
                        {message.text}
                    </div>
                )}

                {/* Navigazione */}
                <div className="flex justify-center p-2 mb-8 bg-gray-800 rounded-xl shadow-inner overflow-x-auto">
                    {navItems.map(item => {
                        const Icon = item.icon;
                        const isActive = page === item.id;
                        return (
                            <button
                                key={item.id}
                                onClick={() => setPage(item.id)}
                                className={`flex items-center px-4 py-2 mx-1 rounded-lg font-semibold transition-all text-sm sm:text-base whitespace-nowrap ${
                                    isActive 
                                        ? 'bg-red-600 text-white shadow-lg' 
                                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                }`}
                            >
                                <Icon className="w-4 h-4 mr-1 sm:mr-2" />
                                {item.label}
                            </button>
                        );
                    })}
                </div>

                {/* Contenuto Pagina */}
                <main className="max-w-4xl mx-auto">
                    {renderPage()}
                </main>
                
                {/* Footer (ID Cittadino) */}
                <div className="max-w-4xl mx-auto mt-10 pt-4 border-t border-gray-700">
                    <div className="flex justify-between items-center text-sm">
                        <p className="text-gray-500">{L.save_progress_text}</p>
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-400 font-medium">{L.id_state}</span>
                            <span className="font-mono text-gray-300 break-all">{userId || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default App;
